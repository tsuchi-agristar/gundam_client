<!DOCTYPE html>
<html lang="jp">
<head>
<meta charset="utf-8">
<title>SEND ENERGY</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="viewport" content="initial-scale=1.0">
<!-- style -->
<link rel="stylesheet" href="../style.css">
<link rel="stylesheet" href="../assets/css/parts.css">
<!-- js -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="../assets/js/common.js"></script>
<script>
  // Explain message
  let explain1_ja = '<span class="c_yellow">エネルギーを送って</span><br>モビルスーツを支援せよ！';
  let explain1_en = '<span class="c_yellow">Give energy</span><br>and back up Mobile Suit!';
  let explain1_cn = '<span class="c_yellow">发送能量</span><br>来支持机动战士吧！';
  let explain1_kr = '<span class="c_yellow">에너지를 보내</span><br>모빌슈트를 지원하라!';

  let endFlag = false;
  let current_pos = 0;
  let cnt = 10;
  let attackSounds = new Array();

  function tapSound(current_pos) {
    attackSounds[current_pos].currentTime = 0;
    attackSounds[current_pos].play();
  }
  function tap() {
    tapSound(current_pos);
    if (current_pos == (attackSounds.length-1)) {
      current_pos = 0;
    }
    current_pos++;
  }
  function battleStart() {
    let lang = window.sessionStorage.getItem('lang');
    switch (lang) {
      case '1':
        $("#loadText").html(explain1_ja);
        break;
      case '2':
        $("#loadText").addClass('en_font').html(explain1_en);
        break;
      case '3':
        $("#loadText").addClass('ch_font font18').html(explain1_cn);
        break;
      case '4':
        $("#loadText").addClass('ko_font font18').html(explain1_kr);
        break;
      default:
        $("#loadText").html(explain1_ja);
        break;
      }
    $("#loadImg").children("img").attr("src","../assets/img/neozeong_load01.png");
  }
  function deleteTapIcon() {
    setTimeout(function(){
    $('.none1').removeClass('active');
    }, 4000);
  }
  function battleEnd() {
    setTimeout(function(){
      $('.none').addClass('active').dequeue()
      // $('#orangeText').removeClass('orangeText');
      $('#orangeText').addClass('clearText');
      $('.bottom_abs_button').css({'display':'none'});
      $(".loadImg").children("img").attr('src', "../assets/img/neozeong_load06.png");
    }, 100);
  }
  function pagination() {
    setTimeout(function(){
      window.location.href = '../result/';
    }, 5000);
  }
  function statusCheck() {
    let timerId;
    // Polling
    let gameStatusCheck = () => {
      $.ajax({
        url: 'https://gundamapim.azurewebsites.net/api/front/status',
        type: 'GET',
        dataType: 'json'
      })
      .done((data) => {
        console.log(JSON.stringify(data));
        if (data == null) {
        console.log("data is null");
        return;
        }
        let status = data.status;
        //For develop
        status = window.sessionStorage.getItem('status');

        // Game Start
        if(status == 2) {
          console.log("Game End...");
          // Stop timer
          clearInterval(timerId);
          // Battle End
          battleEnd();
          // Pagination
          pagination();
        } else {
          console.log("Waiting for game end...");
        }
      })
      .fail((data) => {
        console.log("Exception...");
      })
      .always((data) => {
        // console.log("Complete...");
      });
    }
    // Execute pooling
    timerId = setInterval(gameStatusCheck, 2000);
  }
  function charge() {
    if(endFlag) {
      console.log("Do not charge, because the game has finished.");
      return;
    }
    // Sound
    tap();
    // Charge
    $.ajax({
      url: 'https://gundamapim.azurewebsites.net/api/front/attack',
      type: 'GET',
      dataType: 'json',
      data: {
        sid : window.sessionStorage.getItem('sid'),
        language : window.sessionStorage.getItem('lang'),
        team : window.sessionStorage.getItem('team')
      },
      timeout:3000
    })
    .done((data) => {
      // console.log(JSON.stringify(data));
      if (data == null) {
        console.log("data is null");
        return;
      }
      let l_sid = data.sid;
      let l_status = data.status;
      //For develop
      status = window.sessionStorage.getItem('status');

      if (l_sid == null) {
        console.log("Sid is null, so go to top page.");
        // Page transition to Top Page
        window.location.href="../";
      // Charge
      } else if (l_status == 1) {
        console.log("Game Start...");
      // Game End
      } else if (l_status == 2) {
        console.log("Game End...");
        endFlag = true;
      } else {
        console.log("Unreachble root.");
      }
    })
    .fail((data) => {
      console.log("Exception...");
    })
    .always((data) => {
      // console.log("Complete...");
    });
  }

  // For test
  function charge_test() {
    tap();
  }
  // For test
  function battleStart_test() {
    let lang = window.sessionStorage.getItem('lang');
    switch (lang) {
      case '1':
        $("#loadText").html(explain1_ja);
        break;
      case '2':
        $("#loadText").addClass('en_font').html(explain1_en);
        break;
      case '3':
        $("#loadText").addClass('ch_font font18').html(explain1_cn);
        break;
      case '4':
        $("#loadText").addClass('ko_font font18').html(explain1_kr);
        break;
      default:
        $("#loadText").html(explain1_ja);
        break;
      }
    $("#loadImg").children("img").attr("src","../assets/img/neozeong_load01.png");
  }
  // For test
  function deleteTapIcon_test() {
    setTimeout(function(){
    $('.none1').removeClass('active');
    }, 4000);
  }
  // For test
  function battleEnd_test() {
    setTimeout(function(){
      $('.none').addClass('active').dequeue()
      // $('#orangeText').removeClass('orangeText');
      $('#orangeText').addClass('clearText');
      $('.bottom_abs_button').css({'display':'none'});
      $(".loadImg").children("img").attr('src', "../assets/img/neozeong_load06.png");
    }, 10000);
  }
  // For test
  function pagination_test() {
    setTimeout(function(){
      window.location.href = '../result/';
    }, 12000);
  }

  $(document).ready(function(){
    if (window.ontouchstart === null) {
      window.addEventListener('touchstart', (e) => {
        e.preventDefault();
        charge();
        //For test
        // charge_test();
      });
      window.addEventListener('touchend', (e) => {
      // e.preventDefault();
      });
    } else {
      window.addEventListener('click', (e) => {
        e.preventDefault();
        charge();
        //For test
        // charge_test();
      });
    }
    let heightSize = $(window).height();
    $('.screen_wrap').height(heightSize);
    $('.mask_bg').height(heightSize);
    // Sound
    for(i=0;i<cnt;i++){
      attackSounds.push(new Audio('../assets/mp3/beamgun1.mp3'));
    }
  });
  // Animation of the tap
  $(function(){
    $("#tapBtn").on("click", function(){
			$('.loadWrap img').css("animation", "shake 0.3s");
			var copied = $('.loadWrap').clone(true);
			$('.loadWrap').before(copied);
			$("." + $('.loadWrap').attr("class") + ":last").remove();
    });
  });
</script>
</head>
  <body>
    <div class="none mask_bg mask_bg_battlestart">
      <div class="ttl_center">
        <figure>
          <img src="../assets/img/title_over.png" alt="">
        </figure>
      </div>
    </div>
    <section id="attack_sec" class="tapArea select_sec bg_attack screen_wrap">
      <div class="headTitle">
       <figure>
         <img src="../assets/img/top_bar01.png" alt="装飾ヘッダー">
       </figure>
      </div>
      <div class="pageTitle">
        <p id="orangeText" class="orangeText font40 en_font">SEND ENERGY!</p>
      </div>
      <div class="loadWrap">
        <!-- <figure id="loadImg" class="loadImg shake_btn"> -->
        <figure id="tapBtn">
          <img src="../assets/img/neozeong_load05.png">
        </figure>
      </div>
      <div class="none1 active">
        <div id="sound_btn" class="blinking tap_button">
          <figure class="img_w img_w20">
            <img src="../assets/img/img_tap.png" alt="">
          </figure>
        </div>
      </div>
      <div class="bottom_abs_button zindex_button">
        <div class="flex wrap img_w img_w90">
          <figure class="bg_frame rel">
            <p id="loadText" class="abs_text_center bold font15"></p>
            <figure class="changeFrame">
              <img src="../assets/img/frame_orange.png" alt="赤いフレーム">
            </figure>
          </figure>
        </div>
      </div>
    </section>
    <script>
      // // Battle Start
      // battleStart();
      // // Delete Tap Icon
      // deleteTapIcon();
      // // Game Status Check
      // statusCheck();

      // For test
      battleStart_test();
      deleteTapIcon_test();
      battleEnd_test();
      pagination_test();
    </script>
  </body>
</html>
